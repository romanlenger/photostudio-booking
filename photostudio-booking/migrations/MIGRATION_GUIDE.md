# üîí –ú–Ü–ì–†–ê–¶–Ü–Ø: –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–æ–¥–≤—ñ–π–Ω–æ–≥–æ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è

## –©–û –ó–ú–Ü–ù–ï–ù–û:

### 1. ‚úÖ models.py - –î–æ–¥–∞–Ω–æ UNIQUE constraint:
```python
__table_args__ = (
    UniqueConstraint('booking_date', 'booking_hour', name='unique_booking_slot'),
)
```

### 2. ‚úÖ main.py - –î–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–∫—É IntegrityError:
```python
except IntegrityError:
    db.rollback()
    raise HTTPException(400, "–¶—è –≥–æ–¥–∏–Ω–∞ —â–æ–π–Ω–æ –±—É–ª–∞ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–∞...")
```

### 3. ‚úÖ SQL –º—ñ–≥—Ä–∞—Ü—ñ—è - 001_add_unique_constraint.sql

---

## üöÄ –Ø–ö –ó–ê–°–¢–û–°–£–í–ê–¢–ò:

### –í–∞—Ä—ñ–∞–Ω—Ç 1: –Ø–∫—â–æ –±–∞–∑–∞ –ü–£–°–¢–ê (–Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö):
```bash
# –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç–∏ –≤—Å–µ
docker-compose down -v
docker-compose up --build

# READY! ‚úÖ
```

### –í–∞—Ä—ñ–∞–Ω—Ç 2: –Ø–∫—â–æ —î –î–ê–ù–Ü –≤ –±–∞–∑—ñ:
```bash
# 1. –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é –≤—Ä—É—á–Ω—É
docker-compose exec db psql -U photostudio -d photostudio_db

# 2. –í psql –≤–∏–∫–æ–Ω–∞—Ç–∏:
ALTER TABLE bookings 
ADD CONSTRAINT unique_booking_slot 
UNIQUE (booking_date, booking_hour);

# 3. –í–∏–π—Ç–∏
\q

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏
docker-compose restart web

# READY! ‚úÖ
```

### –í–∞—Ä—ñ–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ —Ñ–∞–π–ª –º—ñ–≥—Ä–∞—Ü—ñ—ó:
```bash
# –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ SQL –º—ñ–≥—Ä–∞—Ü—ñ—é
docker-compose exec db psql -U photostudio -d photostudio_db -f /migrations/001_add_unique_constraint.sql

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏
docker-compose restart web
```

---

## üß™ –Ø–ö –ü–ï–†–ï–í–Ü–†–ò–¢–ò:

### –¢–µ—Å—Ç 1: –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –¥–≤—ñ—á—ñ
```bash
# –ó–∞–ø–∏—Ç 1
curl -X POST http://localhost:8000/api/bookings/ \
  -H "Content-Type: application/json" \
  -d '{"name":"Test","phone":"+380501234567","booking_date":"2025-12-20","booking_hour":14}'

# –ó–∞–ø–∏—Ç 2 (—Ç–∞ —Å–∞–º–∞ –≥–æ–¥–∏–Ω–∞)
curl -X POST http://localhost:8000/api/bookings/ \
  -H "Content-Type: application/json" \
  -d '{"name":"Test2","phone":"+380509876543","booking_date":"2025-12-20","booking_hour":14}'

# –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# –ó–∞–ø–∏—Ç 1: ‚úÖ 201 Created
# –ó–∞–ø–∏—Ç 2: ‚ùå 400 "–¶—è –≥–æ–¥–∏–Ω–∞ —â–æ–π–Ω–æ –±—É–ª–∞ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–∞..."
```

### –¢–µ—Å—Ç 2: –í –±—Ä–∞—É–∑–µ—Ä—ñ
```
1. –í—ñ–¥–∫—Ä–∏—Ç–∏ 2 –≤–∫–ª–∞–¥–∫–∏: http://localhost:8000/
2. –í –æ–±–æ—Ö –æ–±—Ä–∞—Ç–∏ —Ç–æ–π —Å–∞–º–∏–π –¥–µ–Ω—å —ñ –≥–æ–¥–∏–Ω—É
3. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏" –≤ –æ–±–æ—Ö –æ–¥–Ω–æ—á–∞—Å–Ω–æ
4. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   - –ü–µ—Ä—à–∞ –≤–∫–ª–∞–¥–∫–∞: ‚úÖ –£—Å–ø—ñ—à–Ω–æ
   - –î—Ä—É–≥–∞ –≤–∫–ª–∞–¥–∫–∞: ‚ùå "–¶—è –≥–æ–¥–∏–Ω–∞ —â–æ–π–Ω–æ –±—É–ª–∞ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–∞..."
```

---

## üîç –Ø–ö –¶–ï –ü–†–ê–¶–Æ–Ñ:

### –î–û (–±–µ–∑ –∑–∞—Ö–∏—Å—Ç—É):
```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ê: –ü–µ—Ä–µ–≤—ñ—Ä—è—î 14:00 ‚Üí –í—ñ–ª—å–Ω–æ ‚úÖ
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ë: –ü–µ—Ä–µ–≤—ñ—Ä—è—î 14:00 ‚Üí –í—ñ–ª—å–Ω–æ ‚úÖ
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ê: –ë—Ä–æ–Ω—é—î 14:00 ‚Üí –£—Å–ø—ñ—Ö ‚úÖ
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ë: –ë—Ä–æ–Ω—é—î 14:00 ‚Üí –£—Å–ø—ñ—Ö ‚úÖ ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
```

### –ü–Ü–°–õ–Ø (–∑ –∑–∞—Ö–∏—Å—Ç–æ–º):
```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ê: –ü–µ—Ä–µ–≤—ñ—Ä—è—î 14:00 ‚Üí –í—ñ–ª—å–Ω–æ ‚úÖ
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ë: –ü–µ—Ä–µ–≤—ñ—Ä—è—î 14:00 ‚Üí –í—ñ–ª—å–Ω–æ ‚úÖ
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ê: –ë—Ä–æ–Ω—é—î 14:00 ‚Üí –£—Å–ø—ñ—Ö ‚úÖ
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ë: –ë—Ä–æ–Ω—é—î 14:00 ‚Üí PostgreSQL: ‚ùå UNIQUE constraint violation
                            ‚Üí FastAPI: "–¶—è –≥–æ–¥–∏–Ω–∞ —â–æ–π–Ω–æ –±—É–ª–∞ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–∞"
```

---

## üìä –¢–ï–•–ù–Ü–ß–ù–Ü –î–ï–¢–ê–õ–Ü:

### PostgreSQL UNIQUE Constraint:
```sql
-- –ù–∞ —Ä—ñ–≤–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
CREATE UNIQUE INDEX unique_booking_slot 
ON bookings (booking_date, booking_hour);
```

### Python IntegrityError:
```python
from sqlalchemy.exc import IntegrityError

try:
    db.commit()
except IntegrityError:
    # –ë–∞–∑–∞ –≤—ñ–¥—Ö–∏–ª–∏–ª–∞ —á–µ—Ä–µ–∑ –ø–æ—Ä—É—à–µ–Ω–Ω—è UNIQUE constraint
    db.rollback()
    raise HTTPException(400, "–í–∂–µ –∑–∞–π–Ω—è—Ç–æ")
```

---

## ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û:

### –Ø–∫—â–æ —î –¥—É–±–ª—ñ–∫–∞—Ç–∏ –í –Ü–°–ù–£–Æ–ß–Ü–ô –±–∞–∑—ñ:
```sql
-- –ó–Ω–∞–π—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏
SELECT booking_date, booking_hour, COUNT(*) 
FROM bookings 
GROUP BY booking_date, booking_hour 
HAVING COUNT(*) > 1;

-- –í–∏–¥–∞–ª–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏ (–∑–∞–ª–∏—à–∏—Ç–∏ –Ω–∞–π—Å—Ç–∞—Ä—ñ—à–µ)
DELETE FROM bookings a
USING bookings b
WHERE a.id > b.id 
  AND a.booking_date = b.booking_date 
  AND a.booking_hour = b.booking_hour;

-- –¢–µ–ø–µ—Ä –¥–æ–¥–∞—Ç–∏ constraint
ALTER TABLE bookings 
ADD CONSTRAINT unique_booking_slot 
UNIQUE (booking_date, booking_hour);
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢:

- ‚úÖ –ù–µ–º–æ–∂–ª–∏–≤–æ –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –≥–æ–¥–∏–Ω—É –¥–≤—ñ—á—ñ
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –≥–∞—Ä–∞–Ω—Ç—É—î —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å
- ‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º—É—î –∑—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- ‚úÖ –ù–µ–º–∞—î race conditions
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–ø–µ—á–Ω–∞ –ø—Ä–∏ –≤–∏—Å–æ–∫–æ–º—É –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ

**–¢–µ–ø–µ—Ä —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–æ –ø—Ä–æ–¥–∞–∫—à–Ω—É! üöÄ**
